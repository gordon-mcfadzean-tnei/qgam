<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>qgam: quantile non-parametric additive models • qgam</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="qgam: quantile non-parametric additive models">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">qgam</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.3.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/qgam.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>qgam: quantile non-parametric additive models</h1>
                        <h4 class="author">Matteo Fasiolo, Simon N. Wood, Yannig Goude, and Raphael Nedellec</h4>
            
            <h4 class="date">June 20 2019</h4>
      
      
      <div class="hidden name"><code>qgam.Rmd</code></div>

    </div>

    
    
<style>
body {
text-align: justify}
</style>
<p>This R package offers methods for fitting additive quantile regression models based on splines, using the methods described in <a href="https://arxiv.org/abs/1707.03307">Fasiolo et al., 2017</a>.</p>
<p>The main fitting functions are:</p>
<ul>
<li>
<code><a href="../reference/qgam.html">qgam()</a></code> fits an additive quantile regression model to a single quantile. Very similar to <code><a href="https://www.rdocumentation.org/packages/mgcv/topics/gam">mgcv::gam()</a></code>. It returns an object of class <code>qgam</code>, which inherits from <code><a href="https://www.rdocumentation.org/packages/mgcv/topics/gamObject">mgcv::gamObject</a></code>.</li>
<li>
<code><a href="../reference/mqgam.html">mqgam()</a></code> fits the same additive quantile regression model to several quantiles. It is more efficient that calling <code><a href="../reference/qgam.html">qgam()</a></code> several times, especially in terms of memory usage.</li>
<li>
<code><a href="../reference/tuneLearn.html">tuneLearn()</a></code> useful for tuning the learning rate of the Gibbs posterior. It evaluates a calibration loss function on a grid of values provided by the user.</li>
<li>
<code><a href="../reference/tuneLearnFast.html">tuneLearnFast()</a></code> similar to <code><a href="../reference/tuneLearn.html">tuneLearn()</a></code>, but here the learning rate is selected by minimizing the calibration loss, using Brent method.</li>
</ul>
<div id="a-first-example-smoothing-the-motorcycle-dataset" class="section level1">
<h1 class="hasAnchor">
<a href="#a-first-example-smoothing-the-motorcycle-dataset" class="anchor"></a>A first example: smoothing the motorcycle dataset</h1>
<p>Let’s start with a simple example. Here we are fitting a regression model with an adaptive spline basis to quantile 0.8 of the motorcycle dataset.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(qgam); <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(MASS)
if( <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/warning">suppressWarnings</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">require</a></span>(RhpcBLASctl)) ){ <span class="kw"><a href="https://www.rdocumentation.org/packages/RhpcBLASctl/topics/RhpcBLASctl-package">blas_set_num_threads</a></span>(<span class="dv">1</span>) } <span class="co"># Optional</span>

fit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/qgam.html">qgam</a></span>(accel~<span class="kw">s</span>(times, <span class="dt">k=</span><span class="dv">20</span>, <span class="dt">bs=</span><span class="st">"ad"</span>), 
            <span class="dt">data =</span> mcycle, 
            <span class="dt">qu =</span> <span class="fl">0.8</span>)</code></pre></div>
<pre><code>## Estimating learning rate. Each dot corresponds to a loss evaluation. 
## qu = 0.8............done</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Plot the fit</span>
xSeq &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(<span class="st">"accel"</span> =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>, <span class="fl">1e3</span>), <span class="st">"times"</span> =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="dv">2</span>, <span class="dv">58</span>, <span class="dt">length.out =</span> <span class="fl">1e3</span>)))
pred &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict</a></span>(fit, <span class="dt">newdata =</span> xSeq, <span class="dt">se=</span><span class="ot">TRUE</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(mcycle$times, mcycle$accel, <span class="dt">xlab =</span> <span class="st">"Times"</span>, <span class="dt">ylab =</span> <span class="st">"Acceleration"</span>, <span class="dt">ylim =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(-<span class="dv">150</span>, <span class="dv">80</span>))
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(xSeq$times, pred$fit, <span class="dt">lwd =</span> <span class="dv">1</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(xSeq$times, pred$fit +<span class="st"> </span><span class="dv">2</span>*pred$se.fit, <span class="dt">lwd =</span> <span class="dv">1</span>, <span class="dt">col =</span> <span class="dv">2</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(xSeq$times, pred$fit -<span class="st"> </span><span class="dv">2</span>*pred$se.fit, <span class="dt">lwd =</span> <span class="dv">1</span>, <span class="dt">col =</span> <span class="dv">2</span>)   </code></pre></div>
<p><img src="qgam_files/figure-html/1-1.png" width="700" style="display:block; margin: auto"><code>qgam</code> automatically calls <code>tuneLearnFast</code> to select the learning rate. The results of the calibrations are stored in <code>fit$calibr</code>. We can check whether the optimization succeded as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/check.html">check</a></span>(fit$calibr, <span class="dv">2</span>)</code></pre></div>
<p><img src="qgam_files/figure-html/2-1.png" width="700" style="display:block; margin: auto"> The plot suggest that the calibration criterion has a single minimum, and that the optimizer has converged to its neighbourhood. Alternatively, we could have selected the learning rate by evaluating the loss function on a grid.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(<span class="dv">6436</span>)
cal &lt;-<span class="st"> </span><span class="kw"><a href="../reference/tuneLearn.html">tuneLearn</a></span>(accel~<span class="kw">s</span>(times, <span class="dt">k=</span><span class="dv">20</span>, <span class="dt">bs=</span><span class="st">"ad"</span>), 
                 <span class="dt">data =</span> mcycle, 
                 <span class="dt">qu =</span> <span class="fl">0.8</span>,
                 <span class="dt">lsig =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dt">length.out =</span> <span class="dv">20</span>), 
                 <span class="dt">control =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="st">"progress"</span> =<span class="st"> "none"</span>)) <span class="co">#&lt;- sequence of values for learning rate</span>
                 
<span class="kw"><a href="../reference/check.html">check</a></span>(cal)</code></pre></div>
<p><img src="qgam_files/figure-html/3-1.png" width="700" style="display:block; margin: auto"><img src="qgam_files/figure-html/3-2.png" width="700" style="display:block; margin: auto"> Here the generic <code>check</code> function produces a different output. The first plot is the calibration criterion as a function of <span class="math inline">\(log(\sigma)\)</span>, which should look fairly smooth. The second plot shows how the effective degrees of freedom (EDF) vary with <span class="math inline">\(log(\sigma)\)</span>. Notice that here we are using an adaptive smoother, which includes five smoothing parameters.</p>
<p>We might want to fit several quantiles at once. This can be done with <code>mqgam</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">quSeq &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">0.2</span>, <span class="fl">0.4</span>, <span class="fl">0.6</span>, <span class="fl">0.8</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(<span class="dv">6436</span>)
fit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/mqgam.html">mqgam</a></span>(accel~<span class="kw">s</span>(times, <span class="dt">k=</span><span class="dv">20</span>, <span class="dt">bs=</span><span class="st">"ad"</span>), 
             <span class="dt">data =</span> mcycle, 
             <span class="dt">qu =</span> quSeq)</code></pre></div>
<pre><code>## Estimating learning rate. Each dot corresponds to a loss evaluation. 
## qu = 0.4..........done 
## qu = 0.6...........done 
## qu = 0.2............done 
## qu = 0.8..........done</code></pre>
<p>To save memory <code>mqgam</code> does not return one <code><a href="https://www.rdocumentation.org/packages/mgcv/topics/gamObject">mgcv::gamObject</a></code> for each quantile, but it avoids storing some redundant data (such as several copies of the design matrix). The output of <code>mqgam</code> can be manipulated using the <code>qdo</code> function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Plot the data</span>
xSeq &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(<span class="st">"accel"</span> =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>, <span class="fl">1e3</span>), <span class="st">"times"</span> =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="dv">2</span>, <span class="dv">58</span>, <span class="dt">length.out =</span> <span class="fl">1e3</span>)))
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(mcycle$times, mcycle$accel, <span class="dt">xlab =</span> <span class="st">"Times"</span>, <span class="dt">ylab =</span> <span class="st">"Acceleration"</span>, <span class="dt">ylim =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(-<span class="dv">150</span>, <span class="dv">80</span>))

<span class="co"># Predict each quantile curve and plot</span>
for(iq in quSeq){
  pred &lt;-<span class="st"> </span><span class="kw"><a href="../reference/qdo.html">qdo</a></span>(fit, iq, predict, <span class="dt">newdata =</span> xSeq)
  <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(xSeq$times, pred, <span class="dt">col =</span> <span class="dv">2</span>)
}</code></pre></div>
<p><img src="qgam_files/figure-html/5-1.png" width="700" style="display:block; margin: auto"></p>
<p>Using <code>qdo</code> we can print out the summary for each quantile, for instance:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Summary for quantile 0.4</span>
<span class="kw"><a href="../reference/qdo.html">qdo</a></span>(fit, <span class="dt">qu =</span> <span class="fl">0.4</span>, summary)</code></pre></div>
<pre><code>## 
## Family: elf 
## Link function: identity 
## 
## Formula:
## accel ~ s(times, k = 20, bs = "ad")
## 
## Parametric coefficients:
##             Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)  -31.181      1.832  -17.02   &lt;2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Approximate significance of smooth terms:
##            edf Ref.df Chi.sq p-value    
## s(times) 8.968  10.35  666.4  &lt;2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## R-sq.(adj) =  0.781   Deviance explained = 69.9%
## -REML = 609.58  Scale est. = 1         n = 133</code></pre>
<p>Notice that here the generic function <code>summary</code> is calling <code>summary.gam</code>, because <code>summary.qgam</code> has not been implemented yet. Hence one cannot quite rely on the p-value provided by this function, because their are calculated using result that apply to parametric, not quantile, regression.</p>
</div>
<div id="dealing-with-heteroscedasticity" class="section level1">
<h1 class="hasAnchor">
<a href="#dealing-with-heteroscedasticity" class="anchor"></a>Dealing with heteroscedasticity</h1>
<p>Let us simulate some data from an heteroscedastic model.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(<span class="dv">651</span>)
n &lt;-<span class="st"> </span><span class="dv">2000</span>
x &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(-<span class="dv">4</span>, <span class="dv">3</span>, <span class="dt">length.out =</span> n)
X &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(<span class="dv">1</span>, x, x^<span class="dv">2</span>)
beta &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>)
sigma =<span class="st">  </span><span class="fl">1.2</span> +<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Trig">sin</a></span>(<span class="dv">2</span>*x)
f &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/drop">drop</a></span>(X %*%<span class="st"> </span>beta)
dat &lt;-<span class="st"> </span>f +<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(n, <span class="dv">0</span>, sigma)
dataf &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(dat, x))
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(dataf) &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"y"</span>, <span class="st">"x"</span>)
   
qus &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>, <span class="dt">length.out =</span> <span class="dv">5</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(x, dat, <span class="dt">col =</span> <span class="st">"grey"</span>, <span class="dt">ylab =</span> <span class="st">"y"</span>)
for(iq in qus){ <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(x, <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">qnorm</a></span>(iq, f, sigma)) }</code></pre></div>
<p><img src="qgam_files/figure-html/h1-1.png" width="700" style="display:block; margin: auto"></p>
<p>We now fit ten quantiles between 0.05 and 0.95, using a quantile GAM with scalar learning rate.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/mqgam.html">mqgam</a></span>(y~<span class="kw">s</span>(x, <span class="dt">k =</span> <span class="dv">30</span>, <span class="dt">bs =</span> <span class="st">"cr"</span>), 
             <span class="dt">data =</span> dataf,
             <span class="dt">qu =</span> qus)</code></pre></div>
<pre><code>## Estimating learning rate. Each dot corresponds to a loss evaluation. 
## qu = 0.5........done 
## qu = 0.725.......done 
## qu = 0.275.........done 
## qu = 0.95................done 
## qu = 0.05...............done</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">qus &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>, <span class="dt">length.out =</span> <span class="dv">5</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(x, dat, <span class="dt">col =</span> <span class="st">"grey"</span>, <span class="dt">ylab =</span> <span class="st">"y"</span>)
for(iq in qus){ 
 <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(x, <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">qnorm</a></span>(iq, f, sigma), <span class="dt">col =</span> <span class="dv">2</span>)
 <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(x, <span class="kw"><a href="../reference/qdo.html">qdo</a></span>(fit, iq, predict))
}
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/legend">legend</a></span>(<span class="st">"top"</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"truth"</span>, <span class="st">"fitted"</span>), <span class="dt">col =</span> <span class="dv">2</span>:<span class="dv">1</span>, <span class="dt">lty =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">1</span>, <span class="dv">2</span>))</code></pre></div>
<p><img src="qgam_files/figure-html/h2-1.png" width="700" style="display:block; margin: auto"></p>
<p>With the exception of <code>qu = 0.95</code>, the fitted quantiles are close to the true ones, but their credible intervals don’t vary much with x. Indeed, let’s look at intervals for quantile 0.95.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(x, dat, <span class="dt">col =</span> <span class="st">"grey"</span>, <span class="dt">ylab =</span> <span class="st">"y"</span>)
tmp &lt;-<span class="st"> </span><span class="kw"><a href="../reference/qdo.html">qdo</a></span>(fit, <span class="fl">0.95</span>, predict, <span class="dt">se =</span> <span class="ot">TRUE</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(x, tmp$fit)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(x, tmp$fit +<span class="st"> </span><span class="dv">3</span> *<span class="st"> </span>tmp$se.fit, <span class="dt">col =</span> <span class="dv">2</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(x, tmp$fit -<span class="st"> </span><span class="dv">3</span> *<span class="st"> </span>tmp$se.fit, <span class="dt">col =</span> <span class="dv">2</span>)</code></pre></div>
<p><img src="qgam_files/figure-html/h3-1.png" width="700" style="display:block; margin: auto"></p>
<p>We can get better credible intervals, and solve the “wigglines” problem for the top quantile, by letting the learning rate vary with the covariate. In particular, we can use an additive model for quantile location and one for learning rate.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/qgam.html">qgam</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(y~<span class="kw">s</span>(x, <span class="dt">k =</span> <span class="dv">30</span>, <span class="dt">bs =</span> <span class="st">"cr"</span>), ~<span class="st"> </span><span class="kw">s</span>(x, <span class="dt">k =</span> <span class="dv">30</span>, <span class="dt">bs =</span> <span class="st">"cr"</span>)), 
            <span class="dt">data =</span> dataf, <span class="dt">qu =</span> <span class="fl">0.95</span>)</code></pre></div>
<pre><code>## Estimating learning rate. Each dot corresponds to a loss evaluation. 
## qu = 0.95.........done</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(x, dat, <span class="dt">col =</span> <span class="st">"grey"</span>, <span class="dt">ylab =</span> <span class="st">"y"</span>)
tmp &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict</a></span>(fit, <span class="dt">se =</span> <span class="ot">TRUE</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(x, tmp$fit)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(x, tmp$fit +<span class="st"> </span><span class="dv">3</span> *<span class="st"> </span>tmp$se.fit, <span class="dt">col =</span> <span class="dv">2</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(x, tmp$fit -<span class="st"> </span><span class="dv">3</span> *<span class="st"> </span>tmp$se.fit, <span class="dt">col =</span> <span class="dv">2</span>)</code></pre></div>
<p><img src="qgam_files/figure-html/h4-1.png" width="700" style="display:block; margin: auto"> Now the credible intervals correctly represent the underlying uncertainty, and the fit has the correct amount of smoothness.</p>
<p>Neglecting to take the heteroscedasticity into account can lead to bias, in addition to inadequate coverage of the credible intervals. Let’s go back the motorcycle data set, and to the first model we fitted:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/qgam.html">qgam</a></span>(accel~<span class="kw">s</span>(times, <span class="dt">k=</span><span class="dv">20</span>, <span class="dt">bs=</span><span class="st">"ad"</span>), 
            <span class="dt">data =</span> mcycle, 
            <span class="dt">qu =</span> <span class="fl">0.8</span>)</code></pre></div>
<pre><code>## Estimating learning rate. Each dot corresponds to a loss evaluation. 
## qu = 0.8............done</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Plot the fit</span>
xSeq &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(<span class="st">"accel"</span> =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>, <span class="fl">1e3</span>), <span class="st">"times"</span> =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="dv">2</span>, <span class="dv">58</span>, <span class="dt">length.out =</span> <span class="fl">1e3</span>)))
pred &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict</a></span>(fit, <span class="dt">newdata =</span> xSeq, <span class="dt">se=</span><span class="ot">TRUE</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(mcycle$times, mcycle$accel, <span class="dt">xlab =</span> <span class="st">"Times"</span>, <span class="dt">ylab =</span> <span class="st">"Acceleration"</span>, <span class="dt">ylim =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(-<span class="dv">150</span>, <span class="dv">80</span>))
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(xSeq$times, pred$fit, <span class="dt">lwd =</span> <span class="dv">1</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(xSeq$times, pred$fit +<span class="st"> </span><span class="dv">2</span>*pred$se.fit, <span class="dt">lwd =</span> <span class="dv">1</span>, <span class="dt">col =</span> <span class="dv">2</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(xSeq$times, pred$fit -<span class="st"> </span><span class="dv">2</span>*pred$se.fit, <span class="dt">lwd =</span> <span class="dv">1</span>, <span class="dt">col =</span> <span class="dv">2</span>)   </code></pre></div>
<p><img src="qgam_files/figure-html/mcy2rnd-1.png" width="700" style="display:block; margin: auto"></p>
<p>The slightly disturbing thing about this quantile fit is that for <code>Times &lt; 10</code> the fit is clearly above all the responses. But we are fitting quantile 0.8, hence we should expect around 20<span class="math inline">\(\%\)</span> of the responses to be above the fit. The problem here is that the variance of the response (<code>accel</code>) varies wildly with <code>Times</code>, so that the bias induced by the smoothed pinball loss used by <code>qgam</code> is not constant (see Fasiolo et al. 2017 for details). This issue is solved by letting the learning rate change with <code>Times</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/qgam.html">qgam</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(accel ~<span class="st"> </span><span class="kw">s</span>(times, <span class="dt">k=</span><span class="dv">20</span>, <span class="dt">bs=</span><span class="st">"ad"</span>), ~<span class="st"> </span><span class="kw">s</span>(times)),
            <span class="dt">data =</span> mcycle, 
            <span class="dt">qu =</span> <span class="fl">0.8</span>)</code></pre></div>
<pre><code>## Estimating learning rate. Each dot corresponds to a loss evaluation. 
## qu = 0.8................done</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pred &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict</a></span>(fit, <span class="dt">newdata =</span> xSeq, <span class="dt">se=</span><span class="ot">TRUE</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(mcycle$times, mcycle$accel, <span class="dt">xlab =</span> <span class="st">"Times"</span>, <span class="dt">ylab =</span> <span class="st">"Acceleration"</span>, <span class="dt">ylim =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(-<span class="dv">150</span>, <span class="dv">80</span>))
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(xSeq$times, pred$fit, <span class="dt">lwd =</span> <span class="dv">1</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(xSeq$times, pred$fit +<span class="st"> </span><span class="dv">2</span>*pred$se.fit, <span class="dt">lwd =</span> <span class="dv">1</span>, <span class="dt">col =</span> <span class="dv">2</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(xSeq$times, pred$fit -<span class="st"> </span><span class="dv">2</span>*pred$se.fit, <span class="dt">lwd =</span> <span class="dv">1</span>, <span class="dt">col =</span> <span class="dv">2</span>)  </code></pre></div>
<p><img src="qgam_files/figure-html/mcy2rnd2-1.png" width="700" style="display:block; margin: auto"></p>
</div>
<div id="model-checking" class="section level1">
<h1 class="hasAnchor">
<a href="#model-checking" class="anchor"></a>Model checking</h1>
<p>The <code>qgam</code> package provides some functions that can be useful for model checking, but a more complete set of visualisation and checking tools can be found in the <code>mgcViz</code> R package (Fasiolo et al., 2018). In <code>qgam</code> we have:</p>
<ul>
<li>
<code>cqcheck</code> if we are fitting, say, quantile 0.2 we expect roughly <span class="math inline">\(20\%\)</span> of the observations to fall below the fitted quantile. This function produces some plots to verify this.</li>
<li>
<code>cqcheckI</code> interactive version of <code>cqcheckI</code>. Implemented using the <code>shiny</code> package. Not demonstrated here, but see <code><a href="../reference/cqcheckI.html">?cqcheckI</a></code>.</li>
<li>
<code>check.qgam</code> provides some diagnostics regarding the optimization. Mainly based to <code>gam.check</code>.</li>
<li>
<code>check.learn</code> diagnostic checks to verify that the learning rate selection went well. It can be used on the output of <code>tuneLearn</code>.</li>
<li>
<code>check.tuneLearn</code> similar to <code>check.learn</code>, but it can be used on the output of <code>tuneLearn</code> or on the <code>$calibr</code> slot of a <code>qgam</code> object.</li>
</ul>
<p>We start by illustrating the <code>cqcheck</code> function. In particular, let us consider the additive model: <span class="math display">\[
y \sim x+x^2+z+xz/2+e,\;\;\; e \sim N(0, 1)
\]</span> We start by simulating some data from it.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(qgam)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(<span class="dv">15560</span>)
n &lt;-<span class="st"> </span><span class="dv">1000</span>
x &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(n, <span class="dv">0</span>, <span class="dv">1</span>); z &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(n)
X &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(<span class="dv">1</span>, x, x^<span class="dv">2</span>, z, x*z)
beta &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="fl">0.5</span>)
y &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/drop">drop</a></span>(X %*%<span class="st"> </span>beta) +<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(n) 
dataf &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(y, x, z))
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(dataf) &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"y"</span>, <span class="st">"x"</span>, <span class="st">"z"</span>)</code></pre></div>
<p>We fit a linear model to the median and we use <code>cqcheck</code> produce a diagnostic plot.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">qu &lt;-<span class="st"> </span><span class="fl">0.5</span>
fit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/qgam.html">qgam</a></span>(y~x, <span class="dt">qu =</span> qu, <span class="dt">data =</span> dataf)</code></pre></div>
<pre><code>## Estimating learning rate. Each dot corresponds to a loss evaluation. 
## qu = 0.5.........done</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/cqcheck.html">cqcheck</a></span>(<span class="dt">obj =</span> fit, <span class="dt">v =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"x"</span>), <span class="dt">X =</span> dataf, <span class="dt">y =</span> y) </code></pre></div>
<p><img src="qgam_files/figure-html/c2-1.png" width="700" style="display:block; margin: auto"></p>
<p>The <code>cqcheck</code> function takes a <code>qgam</code> object as input and it predicts the conditional quantile using the data in <code>X</code>. Then it bins the responses <code>y</code> using the corresponding values of <code>v</code> and it calculates, for every bin, what fraction of responses falls below the fitted quantile. Given that we are fitting the median, we would expect that around <span class="math inline">\(50\%\)</span> of the point falls below the fit. But, as the plot shows, this fraction varies widely along <code>x</code>. There is clearly a non-linear relation between the quantile location and <code>x</code>, hence we add a smooth for <code>x</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/qgam.html">qgam</a></span>(y~<span class="kw">s</span>(x), <span class="dt">qu =</span> qu, <span class="dt">data =</span> dataf)</code></pre></div>
<pre><code>## Estimating learning rate. Each dot corresponds to a loss evaluation. 
## qu = 0.5........done</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/cqcheck.html">cqcheck</a></span>(<span class="dt">obj =</span> fit, <span class="dt">v =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"x"</span>), <span class="dt">X =</span> dataf, <span class="dt">y =</span> y)</code></pre></div>
<p><img src="qgam_files/figure-html/c3-1.png" width="700" style="display:block; margin: auto"></p>
<p>The deviations from the theoretical quantile (<span class="math inline">\(0.5\)</span>) are much reduced, but let’s look across both <code>x</code> and <code>z</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/cqcheck.html">cqcheck</a></span>(<span class="dt">obj =</span> fit, <span class="dt">v =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"x"</span>, <span class="st">"z"</span>), <span class="dt">X =</span> dataf, <span class="dt">y =</span> y, <span class="dt">nbin =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">5</span>, <span class="dv">5</span>))</code></pre></div>
<p><img src="qgam_files/figure-html/c4-1.png" width="700" style="display:block; margin: auto"></p>
<p>This plot uses binning as before, if a bin is red (green) this means that the fraction of responses falling below the fit is smaller (larger) than 0.5. Bright colours means that the deviation is statistically significant. As we move along <code>z</code> (<code>x2</code> in the plot) the colour changes from green to red, so it make sense drawing a marginal plot for <code>z</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/cqcheck.html">cqcheck</a></span>(<span class="dt">obj =</span> fit, <span class="dt">v =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"z"</span>), <span class="dt">X =</span> dataf, <span class="dt">y =</span> y, <span class="dt">nbin =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">10</span>))</code></pre></div>
<p><img src="qgam_files/figure-html/c5-1.png" width="700" style="display:block; margin: auto"></p>
<p>We are clearly missing an effect here. Given that effect looks pretty linear, we simply add a parametric term to the fit, which seems to solve the problem:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/qgam.html">qgam</a></span>(y~<span class="kw">s</span>(x)+z, <span class="dt">qu =</span> qu, <span class="dt">data =</span> dataf)</code></pre></div>
<pre><code>## Estimating learning rate. Each dot corresponds to a loss evaluation. 
## qu = 0.5.........done</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/cqcheck.html">cqcheck</a></span>(<span class="dt">obj =</span> fit, <span class="dt">v =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"z"</span>))</code></pre></div>
<p><img src="qgam_files/figure-html/c6-1.png" width="700" style="display:block; margin: auto"></p>
<p>But if we look again across both <code>x</code> and <code>z</code> we see that green prevails on the top-left to bottom-right diagonal, while the other diagonal is mainly red.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/cqcheck.html">cqcheck</a></span>(<span class="dt">obj =</span> fit, <span class="dt">v =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"x"</span>, <span class="st">"z"</span>), <span class="dt">nbin =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">5</span>, <span class="dv">5</span>))</code></pre></div>
<p><img src="qgam_files/figure-html/c7-1.png" width="700" style="display:block; margin: auto"></p>
<p>This suggests that adding an interaction between <code>x</code> and <code>z</code> might be a good idea. Indeed, now <code>cqcheck</code> does not signal any problem:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/qgam.html">qgam</a></span>(y~<span class="kw">s</span>(x)+z+<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/AsIs">I</a></span>(x*z), <span class="dt">qu =</span> qu, <span class="dt">data =</span> dataf)</code></pre></div>
<pre><code>## Estimating learning rate. Each dot corresponds to a loss evaluation. 
## qu = 0.5........done</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/cqcheck.html">cqcheck</a></span>(<span class="dt">obj =</span> fit, <span class="dt">v =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"x"</span>, <span class="st">"z"</span>), <span class="dt">nbin =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">5</span>, <span class="dv">5</span>))</code></pre></div>
<p><img src="qgam_files/figure-html/c8-1.png" width="700" style="display:block; margin: auto"></p>
<p>Now that we are fairly satisfied with the model structure, we can, for instance, fit several quantiles by doing:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/mqgam.html">mqgam</a></span>(y~<span class="kw">s</span>(x)+z+<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/AsIs">I</a></span>(x*z), <span class="dt">qu =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">0.2</span>, <span class="fl">0.4</span>, <span class="fl">0.6</span>, <span class="fl">0.8</span>), <span class="dt">data =</span> dataf)</code></pre></div>
<pre><code>## Estimating learning rate. Each dot corresponds to a loss evaluation. 
## qu = 0.4........done 
## qu = 0.6.........done 
## qu = 0.2.......done 
## qu = 0.8...............done</code></pre>
<p>We can then check whether the learning rate was selected correctly. Recall that the <code>qgam</code> function calls internally <code>tuneLearnFast</code>, hence we can look at how the calibration went by doing:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/check.learnFast.html">check.learnFast</a></span>(fit$calibr, <span class="dv">2</span>:<span class="dv">5</span>)</code></pre></div>
<p><img src="qgam_files/figure-html/c10-1.png" width="700" style="display:block; margin: auto"></p>
<p>For each quantile, the calibration loss seems to have a unique minimum, which is what one would hope. Objects of class <code>qgam</code> can also be checked using the generic function <code>check</code>, which defaults to <code>check.qgam</code>. To use this function on the output of <code>mqgam</code>, we must use the <code>qdo</code> function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/qdo.html">qdo</a></span>(fit, <span class="fl">0.2</span>, check)</code></pre></div>
<p><img src="qgam_files/figure-html/c11-1.png" width="700" style="display:block; margin: auto"><img src="qgam_files/figure-html/c11-2.png" width="700" style="display:block; margin: auto"></p>
<pre><code>## Theor. proportion of neg. resid.: 0.2   Actual proportion: 0.198
## Integrated absolute bias |F(mu) - F(mu0)| = 0.01025554
## Method: REML   Optimizer: outer newton
## full convergence after 4 iterations.
## Gradient range [0.00075606,0.00075606]
## (score 1658.424 &amp; scale 1).
## Hessian positive definite, eigenvalue range [3.83483,3.83483].
## Model rank =  12 / 12 
## 
## Basis dimension (k) check: if edf is close too k' (maximum possible edf) 
## it might be worth increasing k. 
## 
##      k'  edf
## s(x)  9 7.38</code></pre>
<pre><code>## NULL</code></pre>
<p>The printed output gives some information about the optimizer used to estimate the smoothing parameters, for fixed learning rate. See <code><a href="../reference/check.qgam.html">?check.qgam</a></code> for more information. The plot has been obtained using <code>cqcheck</code>, where each data point has been binned using the fitted values. On the right side of the plot there seems to be some large deviations, but the rug shows that there are very few data points there.</p>
</div>
<div id="setting-the-loss-smoothing-parameter-and-checking-convergence" class="section level1">
<h1 class="hasAnchor">
<a href="#setting-the-loss-smoothing-parameter-and-checking-convergence" class="anchor"></a>Setting the loss-smoothing parameter and checking convergence</h1>
<p>Let’s simulate some data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(<span class="dv">5235</span>)
n &lt;-<span class="st"> </span><span class="dv">1000</span>
x &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(-<span class="dv">3</span>, <span class="dv">3</span>, <span class="dt">length.out =</span> n)
X &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(<span class="dv">1</span>, x, x^<span class="dv">2</span>)
beta &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>)
f &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/drop">drop</a></span>(X %*%<span class="st"> </span>beta)
dat &lt;-<span class="st"> </span>f +<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/GammaDist">rgamma</a></span>(n, <span class="dv">4</span>, <span class="dv">1</span>)
dataf &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(dat, x))
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(dataf) &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"y"</span>, <span class="st">"x"</span>)</code></pre></div>
<p>Assume that we want to estimate quantiles 0.05, 0.5 and 0.95:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">qus &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">0.05</span>, <span class="fl">0.5</span>, <span class="fl">0.95</span>)
fit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/mqgam.html">mqgam</a></span>(y ~<span class="st"> </span><span class="kw">s</span>(x), <span class="dt">data =</span> dataf, <span class="dt">qu =</span> qus)</code></pre></div>
<pre><code>## Estimating learning rate. Each dot corresponds to a loss evaluation. 
## qu = 0.5........done 
## qu = 0.95........done 
## qu = 0.05.................done</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(x, dat, <span class="dt">col =</span> <span class="st">"grey"</span>, <span class="dt">ylab =</span> <span class="st">"y"</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(x, f +<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/GammaDist">qgamma</a></span>(<span class="fl">0.95</span>, <span class="dv">4</span>, <span class="dv">1</span>), <span class="dt">lty =</span> <span class="dv">2</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(x, f +<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/GammaDist">qgamma</a></span>(<span class="fl">0.5</span>, <span class="dv">4</span>, <span class="dv">1</span>), <span class="dt">lty =</span> <span class="dv">2</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(x, f +<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/GammaDist">qgamma</a></span>(<span class="fl">0.05</span>, <span class="dv">4</span>, <span class="dv">1</span>), <span class="dt">lty =</span> <span class="dv">2</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(x, <span class="kw"><a href="../reference/qdo.html">qdo</a></span>(fit, qus[<span class="dv">1</span>], predict), <span class="dt">col =</span> <span class="dv">2</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(x, <span class="kw"><a href="../reference/qdo.html">qdo</a></span>(fit, qus[<span class="dv">2</span>], predict), <span class="dt">col =</span> <span class="dv">2</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(x, <span class="kw"><a href="../reference/qdo.html">qdo</a></span>(fit, qus[<span class="dv">3</span>], predict), <span class="dt">col =</span> <span class="dv">2</span>)</code></pre></div>
<p><img src="qgam_files/figure-html/check2-1.png" width="700" style="display:block; margin: auto"></p>
<p>Since <code>qgam</code> version 1.3 the parameter <code>err</code>, which determines the smoothness of the loss function used by <code>qgam</code>, is determined automatically. But there might be scenarios where you might want to chose is manually, so let’s try to use several values of <code>err</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">lfit &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.5</span>),
               function(.inp){
                 <span class="kw"><a href="../reference/mqgam.html">mqgam</a></span>(y ~<span class="st"> </span><span class="kw">s</span>(x), <span class="dt">data =</span> dataf, <span class="dt">qu =</span> qus, <span class="dt">err =</span> .inp, 
                       <span class="dt">control =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="st">"progress"</span> =<span class="st"> </span>F))
               })

<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(x, dat, <span class="dt">col =</span> <span class="st">"grey"</span>, <span class="dt">ylab =</span> <span class="st">"y"</span>, <span class="dt">ylim =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(-<span class="dv">2</span>, <span class="dv">20</span>))
colss &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/grDevices/topics/palettes">rainbow</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(lfit))
for(ii in <span class="dv">1</span>:<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(lfit)){
  <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(x, <span class="kw"><a href="../reference/qdo.html">qdo</a></span>(lfit[[ii]], qus[<span class="dv">1</span>], predict), <span class="dt">col =</span> colss[ii])
  <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(x, <span class="kw"><a href="../reference/qdo.html">qdo</a></span>(lfit[[ii]], qus[<span class="dv">2</span>], predict), <span class="dt">col =</span> colss[ii])
  <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(x, <span class="kw"><a href="../reference/qdo.html">qdo</a></span>(lfit[[ii]], qus[<span class="dv">3</span>], predict), <span class="dt">col =</span> colss[ii])
}
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(x, f +<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/GammaDist">qgamma</a></span>(<span class="fl">0.95</span>, <span class="dv">4</span>, <span class="dv">1</span>), <span class="dt">lty =</span> <span class="dv">2</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(x, f +<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/GammaDist">qgamma</a></span>(<span class="fl">0.5</span>, <span class="dv">4</span>, <span class="dv">1</span>), <span class="dt">lty =</span> <span class="dv">2</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(x, f +<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/GammaDist">qgamma</a></span>(<span class="fl">0.05</span>, <span class="dv">4</span>, <span class="dv">1</span>), <span class="dt">lty =</span> <span class="dv">2</span>)</code></pre></div>
<p><img src="qgam_files/figure-html/check2b-1.png" width="700" style="display:block; margin: auto"> The bias increases with <code>err</code>, and it is upward (downward) for high (low) quantiles. The median fit is not much affected by <code>err</code>. The bias really starts appearing for <code>err &gt; 0.1</code>. Decreasing <code>err</code> tends to slow down computation:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/system.time">system.time</a></span>( fit1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/qgam.html">qgam</a></span>(y ~<span class="st"> </span><span class="kw">s</span>(x), <span class="dt">data =</span> dataf, <span class="dt">qu =</span> <span class="fl">0.95</span>, <span class="dt">err =</span> <span class="fl">0.05</span>, 
                           <span class="dt">control =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="st">"progress"</span> =<span class="st"> </span>F)) )[[<span class="dv">3</span>]]</code></pre></div>
<pre><code>## [1] 0.264</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/system.time">system.time</a></span>( fit2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/qgam.html">qgam</a></span>(y ~<span class="st"> </span><span class="kw">s</span>(x), <span class="dt">data =</span> dataf, <span class="dt">qu =</span> <span class="fl">0.95</span>, <span class="dt">err =</span> <span class="fl">0.001</span>, 
                           <span class="dt">control =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="st">"progress"</span> =<span class="st"> </span>F)) )[[<span class="dv">3</span>]]</code></pre></div>
<pre><code>## [1] 27.455</code></pre>
<p>Even worse, it can lead to numeric problems. Here we check that we have found the minimum of the calibration loss:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/check.html">check</a></span>(fit1$calibr, <span class="dt">sel =</span> <span class="dv">2</span>)</code></pre></div>
<p><img src="qgam_files/figure-html/check4-1.png" width="700" style="display:block; margin: auto"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/check.html">check</a></span>(fit2$calibr, <span class="dt">sel =</span> <span class="dv">2</span>)</code></pre></div>
<p><img src="qgam_files/figure-html/check4-2.png" width="700" style="display:block; margin: auto"> In the first case the loss looks smooth and with as single minimum, in the second case we have some instabilities. If the calibration loss looks like this, you generally have to increase <code>err</code>.</p>
<p>We can use <code>check</code> to have an estimate of the bias and to have information regarding the convergence of the smoothing parameter estimation routine:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/check.html">check</a></span>(fit1)</code></pre></div>
<p><img src="qgam_files/figure-html/check5-1.png" width="700" style="display:block; margin: auto"><img src="qgam_files/figure-html/check5-2.png" width="700" style="display:block; margin: auto"></p>
<pre><code>## Theor. proportion of neg. resid.: 0.95   Actual proportion: 0.951
## Integrated absolute bias |F(mu) - F(mu0)| = 0.001017127
## Method: REML   Optimizer: outer newton
## full convergence after 5 iterations.
## Gradient range [4.449524e-08,4.449524e-08]
## (score 3438.722 &amp; scale 1).
## Hessian positive definite, eigenvalue range [1.428662,1.428662].
## Model rank =  10 / 10 
## 
## Basis dimension (k) check: if edf is close too k' (maximum possible edf) 
## it might be worth increasing k. 
## 
##      k'  edf
## s(x)  9 5.05</code></pre>
<p>The second plot suggest that the actual bias is much lower than the bound <code>err = 0.05</code>. This is also supported by the first two lines of text, which say that 95.1% of the residuals are negative, which is very close to the theoretical 95%. The text says that full convergence in smoothing parameter estimation has been achieved, it is important to check this.</p>
<p>In summary, practical experience suggests that:</p>
<ul>
<li>the automatic procedure for selecting <code>err</code> offer a good compromise between bias and stability;</li>
<li>the old default (<code>qgam</code> version &lt; 1.3) was <code>err = 0.05</code>, which generally does not imply too much bias;</li>
<li>if the calibration loss plotted by <code><a href="../reference/check.html">check(fit$learn)</a></code> is irregular, try to increase <code>err</code>;</li>
<li>same if the text printed by <code><a href="../reference/check.html">check(fit)</a></code> does not say that <code>full convergence</code> was achieved;</li>
<li>you can estimate the bias using <code><a href="../reference/check.html">check(fit)</a></code>;</li>
<li>if you have to increase <code>err</code> to 0.2 or higher, there might be something wrong with your model;</li>
<li>you might get messages saying that <code>outer Newton did not converge fully</code> during estimation. This might not be problematic as long as the calibration loss is smooth and <code>full convergence</code> was achieved;</li>
<li>in preliminary studies do not decrease <code>err</code> too much, as it slows down computation;</li>
<li>setting <code>err</code> too low is not a good idea: it is much better to have some bias than numerical problems.</li>
</ul>
</div>
<div id="application-to-probabilistic-electricity-load-forecasting" class="section level1">
<h1 class="hasAnchor">
<a href="#application-to-probabilistic-electricity-load-forecasting" class="anchor"></a>Application to probabilistic electricity load forecasting</h1>
<p>Here we consider a UK electricity demand dataset, taken from the national grid <a href="http://www2.nationalgrid.com/">website</a>. The dataset covers the period January 2011 to June 2016 and it contains the following variables:</p>
<ul>
<li>
<code>NetDemand</code> net electricity demand between 11:30am and 12am.</li>
<li>
<code>wM</code> instantaneous temperature, averaged over several English cities.</li>
<li>
<code>wM_s95</code> exponential smooth of <code>wM</code>, that is <code>wM_s95[i] = a*wM[i] + (1-a)*wM_s95[i]</code> with <code>a=0.95</code>.</li>
<li>
<code>Posan</code> periodic index in <code>[0, 1]</code> indicating the position along the year.</li>
<li>
<code>Dow</code> factor variable indicating the day of the week.</li>
<li>
<code>Trend</code> progressive counter, useful for defining the long term trend.</li>
<li>
<code>NetDemand.48</code> lagged version of <code>NetDemand</code>, that is <code>NetDemand.48[i] = NetDemand[i-2]</code>.</li>
<li>
<code>Holy</code> binary variable indicating holidays.</li>
<li>
<code>Year</code> and <code>Date</code> should obvious, and partially redundant.</li>
</ul>
<p>See <a href="https://arxiv.org/abs/1707.03307">Fasiolo et al., 2017</a> for more details. This is how the demand over the period looks like:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(<span class="st">"UKload"</span>)
tmpx &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(UKload$Year[<span class="dv">1</span>], <span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">tail</a></span>(UKload$Year, <span class="dv">1</span>), <span class="dt">length.out =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(UKload)) 
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(tmpx, UKload$NetDemand, <span class="dt">type =</span> <span class="st">'l'</span>, <span class="dt">xlab =</span> <span class="st">'Year'</span>, <span class="dt">ylab =</span> <span class="st">'Load'</span>)</code></pre></div>
<p><img src="qgam_files/figure-html/edf1-1.png" width="700" style="display:block; margin: auto"></p>
<p>To estimate the median demand, we consider the following model</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">qu &lt;-<span class="st"> </span><span class="fl">0.5</span>
form &lt;-<span class="st"> </span>NetDemand~<span class="kw">s</span>(wM,<span class="dt">k=</span><span class="dv">20</span>,<span class="dt">bs=</span><span class="st">'cr'</span>) +<span class="st"> </span><span class="kw">s</span>(wM_s95,<span class="dt">k=</span><span class="dv">20</span>,<span class="dt">bs=</span><span class="st">'cr'</span>) +<span class="st"> </span>
<span class="st">        </span><span class="kw">s</span>(Posan,<span class="dt">bs=</span><span class="st">'ad'</span>,<span class="dt">k=</span><span class="dv">30</span>,<span class="dt">xt=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="st">"bs"</span>=<span class="st">"cc"</span>)) +<span class="st"> </span>Dow +<span class="st"> </span><span class="kw">s</span>(Trend,<span class="dt">k=</span><span class="dv">4</span>) +<span class="st"> </span>NetDemand<span class="fl">.48</span> +<span class="st"> </span>Holy</code></pre></div>
<p>Notice that we use very few knots for the long term trend, this is because we don’t want to end up interpolating the data. We use an adaptive cyclic smooth for <code>Posan</code>, we’ll explain later why adaptivity is needed here.</p>
<p>Now we tune the learning rate on a grid, on two cores. As the first plot shows, the calibrations loss is minimized at <span class="math inline">\(\log (\sigma)\approx 6\)</span>, the second plot shows how the effective degrees of freedom of each smooth term changes with <span class="math inline">\(\log (\sigma)\)</span>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(<span class="dv">41241</span>)
sigSeq &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="dv">4</span>, <span class="dv">8</span>, <span class="dt">length.out =</span> <span class="dv">16</span>)
closs &lt;-<span class="st"> </span><span class="kw"><a href="../reference/tuneLearn.html">tuneLearn</a></span>(<span class="dt">form =</span> form, <span class="dt">data =</span> UKload, 
                   <span class="dt">lsig =</span> sigSeq, <span class="dt">qu =</span> qu, <span class="dt">control =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="st">"K"</span> =<span class="st"> </span><span class="dv">20</span>), 
                   <span class="dt">multicore =</span> <span class="ot">TRUE</span>, <span class="dt">ncores =</span> <span class="dv">2</span>)

<span class="kw"><a href="../reference/check.html">check</a></span>(closs)</code></pre></div>
<p><img src="qgam_files/figure-html/edf3-1.png" width="700" style="display:block; margin: auto"><img src="qgam_files/figure-html/edf3-2.png" width="700" style="display:block; margin: auto"></p>
<p>Now let’s fit the model with the learning rate corresponding to the lowest loss and let’s look at the resulting smooth effects.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">lsig &lt;-<span class="st"> </span>closs$lsig
fit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/qgam.html">qgam</a></span>(<span class="dt">form =</span> form, <span class="dt">data =</span> UKload, <span class="dt">lsig =</span> lsig, <span class="dt">qu =</span> qu)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(fit, <span class="dt">scale =</span> F, <span class="dt">page =</span> <span class="dv">1</span>)</code></pre></div>
<p><img src="qgam_files/figure-html/edf4-1.png" width="700" style="display:block; margin: auto"></p>
<p>The effect of temperature (<code>wM</code>) is minimized around 18 degrees, which is reasonable. The cyclic effect of <code>Posan</code> has a very sharp drop corresponding to the winter holidays, we used an adaptive smooth in order to have more flexibility during this period. Now we can have a look as some diagnostic plot:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mfrow =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">2</span>, <span class="dv">2</span>))
<span class="kw"><a href="../reference/cqcheck.html">cqcheck</a></span>(fit, <span class="dt">v =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"wM"</span>), <span class="dt">main =</span> <span class="st">"wM"</span>)
<span class="kw"><a href="../reference/cqcheck.html">cqcheck</a></span>(fit, <span class="dt">v =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"wM_s95"</span>), <span class="dt">main =</span> <span class="st">"wM_s95"</span>)
<span class="kw"><a href="../reference/cqcheck.html">cqcheck</a></span>(fit, <span class="dt">v =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"Posan"</span>), <span class="dt">main =</span> <span class="st">"Posan"</span>)
<span class="kw"><a href="../reference/cqcheck.html">cqcheck</a></span>(fit, <span class="dt">v =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"Trend"</span>), <span class="dt">main =</span> <span class="st">"Trend"</span>, <span class="dt">xaxt=</span><span class="st">'n'</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/axis">axis</a></span>(<span class="dv">1</span>, <span class="dt">at =</span> UKload$Trend[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>, <span class="dv">500</span>, <span class="dv">1000</span>, <span class="dv">1500</span>, <span class="dv">2000</span>)], 
             UKload$Year[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>, <span class="dv">500</span>, <span class="dv">1000</span>, <span class="dv">1500</span>, <span class="dv">2000</span>)] )</code></pre></div>
<p><img src="qgam_files/figure-html/edf5-1.png" width="700" style="display:block; margin: auto"></p>
<p>The plots for <code>wM_s95</code> and <code>Posan</code> don’t show any important deviation from 0.5, the target quantile. Along <code>wM</code> we see a large deviation, but we have essentially no data for very high temperatures. If we look at deviations along the <code>Trend</code> variable, which is just a time counter, we see several important deviations. It would be interesting verifying why these occur (we have no answer currently).</p>
<p>Finally, recall that we can produce 2D versions of these diagnostic plots, for instance:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mfrow =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>, <span class="dv">1</span>))
<span class="kw"><a href="../reference/cqcheck.html">cqcheck</a></span>(fit, <span class="dt">v =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"wM"</span>, <span class="st">"Posan"</span>), <span class="dt">scatter =</span> T)</code></pre></div>
<p><img src="qgam_files/figure-html/edf6-1.png" width="700" style="display:block; margin: auto"></p>
</div>
<div id="references" class="section level1">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<ul>
<li><p>Fasiolo, M., Goude, Y., Nedellec, R. and Wood, S. N. (2017). Fast calibrated additive quantile regression. Available at <a href="https://arxiv.org/abs/1707.03307" class="uri">https://arxiv.org/abs/1707.03307</a></p></li>
<li><p>Fasiolo, M., Nedellec, R., Goude, Y. and Wood, S.N. (2018). Scalable visualisation methods for modern Generalized Additive Models. Available at <a href="https://arxiv.org/abs/1809.10632" class="uri">https://arxiv.org/abs/1809.10632</a></p></li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#a-first-example-smoothing-the-motorcycle-dataset">A first example: smoothing the motorcycle dataset</a></li>
      <li><a href="#dealing-with-heteroscedasticity">Dealing with heteroscedasticity</a></li>
      <li><a href="#model-checking">Model checking</a></li>
      <li><a href="#setting-the-loss-smoothing-parameter-and-checking-convergence">Setting the loss-smoothing parameter and checking convergence</a></li>
      <li><a href="#application-to-probabilistic-electricity-load-forecasting">Application to probabilistic electricity load forecasting</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Matteo Fasiolo.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
